---
title: "Practical IRT Modeling in brms"
author: "Bertrand Wilden"
date: "2024-05-29"
categories: [Bayes, Tutorial, brms]
max-description-length: 20
draft: true
execute: 
  message: false
  warning: false
---

## Introduction to IRT

Item-Response Theory (IRT) models are a class of models used to measure latent traits in individuals.[^1] These are characteristics which we cannot observe directly, such as height or weight, but instead have to infer indirectly through observed actions. For example, a student's responses to questions on an exam might give us some idea about their latent ability---or a politician's votes in Congress might give us some idea about their underlying political ideology.

[^1]: IRT can also be used on non-individual units, such as organizations, but most examples use individual people.

Say we want to estimate how left-wing or right-wing a Supreme Court justice is. We will call this ideology variable $\theta$. One place is start would be to qualitatively code each Supreme Court decision as either being liberal or conservative, and then look at the proportion of times each justice sided with the conservative outcome. Expressed as a statistical model we get:

$$
\begin{aligned}
y_{ij} \sim \text{Bernoulli}(\Phi(\theta_i))
\end{aligned}
$$ {#eq-0pl}

Where whether each justice sides with a conservative decision ($y_{ij}$) is based probabilistically on the (scaled) proportion of conservative positions ($\theta_i$). The Standard Normal cumulative distribution function ($\Phi$) is there to add some random noise in the model. We don't want our ideology measurements to be deterministic based on past decisions. Instead, we want to allow some room for some idiosyncratic errors to occur. On even the most conservative possible decision, we allow for *some* probability that Clarence Thomas sides with the liberals.

The model in @eq-0pl has at least one major flaw. Because there are only parameters for justices ($\theta_i$) and none for cases, it treats all cases before the Supreme Court as interchangeable. Additive indices such as these implicitly assume that each "item" (i.e. case) contributes the same amount of weight towards measuring the latent variable in question. In the example of the Supreme Court this is clearly a bad assumption to make since some cases clearly have more ideological importance than others.[^2]

[^2]: The no-ideological-difference-among-items assumption is pretty much always wrong, yet researchers continue to use additive index scales of latent variables in the social sciences all time.

$$
\begin{aligned}
y_{ij} \sim \text{Bernoulli}(\Phi(\theta_i + \xi_j))
\end{aligned}
$$ {#eq-1pl}

Let's fix this flaw by adding a case parameter ($\xi_j$) to the model. @eq-1pl is commonly known as the "1-Parameter IRT Model". Each case 


```{r}
library(dplyr)
library(brms)
library(tidybayes)
library(ggplot2)
library(ggdist)
```

```{css, echo=FALSE}
.title {
  color: #f5f5f5;
}
```

```{r}
votes <- readr::read_csv(here::here("posts", "irt-brms", "data-raw", "SCDB_2023_01_justiceCentered_Vote.csv"))
```

```{r}
votes_recent <- votes |> 
  filter(term == 2022) |> 
  mutate(direction = case_when(direction == 2 ~ 1,
                               direction == 1 ~ 2,
                               .default = NA))
```

```{r}
irt_formula <- bf(
  direction ~ gamma * theta + xi,
  gamma ~ (1 | caseId),
  theta ~ (1 | justiceName),
  xi ~ (1 | caseId),
  nl = TRUE
)

irt_priors <- 
  prior(normal(0, 2), class = b, nlpar = gamma, lb = 0) +
  prior(normal(0, 2), class = b, nlpar = theta) +
  prior(normal(0, 2), class = b, nlpar = xi)
```


```{r}
#| eval: false
get_prior(
  formula = irt_formula, 
  data = votes_recent, 
  family = bernoulli(link = "probit")
)
```


```{r}
irt_fit <- brm(
  formula = irt_formula,
  prior = irt_priors,
  data = votes_recent,
  family = bernoulli(link = "probit"),
  backend = "cmdstanr",
  cores = 8,
  threads = threading(2),
  control = list(adapt_delta = 0.99,
                 max_treedepth = 15),
  refresh = 0,
  seed = 111
)
```


```{r}
summary(irt_fit)
```


```{r}
#| eval: false
get_variables(irt_fit)
```


```{r}
justice_draw <- irt_fit |> 
  spread_draws(r_justiceName__theta[justice,]) |> 
  ungroup() |> 
  mutate(justice = case_when(justice == "SAAlito" ~ "Alito",
                             justice == "CThomas" ~ "Thomas",
                             justice == "NMGorsuch" ~ "Gorsuch",
                             justice == "ACBarrett" ~ "Barrett",
                             justice == "JGRoberts" ~ "Roberts",
                             justice == "BMKavanaugh" ~ "Kavanaugh",
                             justice == "KBJackson" ~ "Jackson",
                             justice == "EKagan" ~ "Kagan",
                             justice == "SSotomayor" ~ "Sotomayor"),
         theta = r_justiceName__theta,
         justice = forcats::fct_reorder(justice, theta))
```


```{r}
justice_draw |> 
  ggplot(aes(x = theta, 
             y = justice)) +
  stat_slabinterval(aes(fill_ramp = after_stat(x)),
                    fill = "green",
                    density = "unbounded",
                    alpha = .75) +
  scale_fill_ramp_continuous(from = "blue") +
  xlim(c(-3.5, 3.5)) +
  labs(x = "Ideology", y = "", title = "2022 Term") +
  theme_minimal()

# ggsave("judge_ideolog.png", bg = "white")
```


